<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>chart</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.2.2/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/css/DarkTheme.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js"></script>
</head>

<body>
<h1>Glucose level</h1>

<canvas id="glucoseLevel" width="975" height="480"></canvas>
<script th:inline="javascript">
const ctx = document.getElementById('glucoseLevel').getContext('2d');

var fetchedData = [[${data}]];

var safeLowValue = 72;
var safeHighValue = 126;
xMaxCurrent = fetchedData.timeStamps.length;
var textPos;
if(xMaxCurrent <= 2){
    textPos = 0.5;
}
else{
    textPos = xMaxCurrent/2;
}

var options = {
    responsive: false,
    maintainAspectRatio: false,
    animation:false,

    plugins:{
        autocolors: false,
        annotation:{
            annotations:{
                box1:{
                    drawTime:'beforeDraw',
                    type: 'box',
                    xMin: 0,
                    xMax: xMaxCurrent,
                    yMin: safeLowValue,
                    yMax: safeHighValue,
                    backgroundColor: '#555555',
                },
                line1:{
                    type: 'line',
                    yMin: safeLowValue,
                    yMax: safeLowValue,
                    borderColor: '#dddddd'
                },
                line2:{
                    type: 'line',
                    yMin: safeHighValue,
                    yMax: safeHighValue,
                    borderColor: '#dddddd'
                },
                label1:{
                    type: 'label',
                    xValue:textPos,
                    yValue: safeLowValue + 3,
                    backgroundColor: 'transparent',
                    content:["safe low bound"],
                    color: '#2b2b2b'
                },
                label2:{
                    type: 'label',
                    xValue:textPos,
                    yValue: safeHighValue - 3,
                    backgroundColor: 'transparent',
                    content:["safe high bound"],
                    color: '#2b2b2b'
                }
            }
        }
    },

};

const myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: fetchedData.timeStamps,
        datasets: [{
            label: 'blood glucose mg/dL',
            data: fetchedData.data,
            borderColor: '#d44f00',
            backgroundColor: '#d44f00',
        }],
    },
    options: options,
    plugins: ['chartjs-plugin-annotation']
});
</script>
<button class="button-77" role="button">BOLUS</button>
<h1 id="battery">Battery level : </h1> <h1 id="bData" th:text="${batteryLevel}!=null?${batteryLevel}+'%':'N/R'"></h1>
<h1 id="insulinReservoir">Insulin reservoir : </h1> <h1 id="iData" th:text="${insulinReservoir}!=null?${insulinReservoir}+'%':'N/R'"></h1>
<h1 id="selfTest"> Device status: </h1> <h1 id="dData" th:text="${deviceStatus}!=null?${deviceStatus}:'N/R'"></h1>
<h1 id="graph"> Graph: </h1> <h1 id="gData" th:text="${graphDuration}!=null?${graphDuration}:'N/R'"></h1>
<h1 id="bloodGlucose"> BG: </h1> <h1 id="bgData" th:text = "${lastBloodGlucoseRead}!=null?${lastBloodGlucoseRead}+' mg/dL':'N/R'"></h1>
<h1 id="insulinUnits"> Insulin delivered: </h1> <h1 id="diData" th:text = "${deliveredInsulin}!=null?${deliveredInsulin}+' units':'N/R'"></h1>
</body>
</html>